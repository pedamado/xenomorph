<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mother: Xenomorph Website Parser</title>
    <!-- JetBrains Mono & VT323 Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      /* XenoMorph Design System: "Mother" Aesthetic */
      :root {
        --smoke-black: #0d0d0d;
        --off-white: #f5f5f5;
        --terminal-green: #4af626;
        --muted-green: #2d5a27;
        --accent-red: #ff4d4d;
        --accent-yellow: #ffcc00;

        --bg-color: var(--smoke-black);
        --fg-color: var(--off-white);
        --border-color: #222;
        --card-bg: #111;
        --fs-base: 1rem;
        --fs-h2: 1.25rem;
        --fs-h1: 1.563rem;
        --fs-small: 0.8rem;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg-color: var(--off-white);
          --fg-color: var(--smoke-black);
          --border-color: #ddd;
          --card-bg: #fff;
          --terminal-green: #1c8b1c;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background-color: var(--bg-color);
        color: var(--fg-color);
        font-family: "JetBrains Mono", monospace;
        line-height: 1.6;
        padding: 2.5rem;
        min-height: 100dvh;
        transition:
          background-color 0.3s,
          color 0.3s;
      }
      header {
        border-bottom: 2px solid var(--terminal-green);
        padding-bottom: 1.5rem;
        margin-bottom: 3rem;
        position: relative;
      }
      header::after {
        content: "MU-TH-UR 6000 SYSTEM ONLINE";
        position: absolute;
        bottom: -25px;
        right: 0;
        font-size: 0.7rem;
        color: var(--muted-green);
      }
      h1 {
        font-size: var(--fs-h1);
        color: var(--terminal-green);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 0.5rem;
      }
      h2 {
        font-size: var(--fs-h2);
        color: var(--fg-color);
        font-weight: 300;
        opacity: 0.8;
      }

      .input-organism {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 4rem;
        max-width: 800px;
        position: sticky;
        top: 0;
        background: var(--bg-color);
        z-index: 100;
        padding-top: 1rem;
        padding-bottom: 1.5rem;
        transition: background-color 0.3s;
      }

      .mode-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
      }
      .mode-btn {
        background: transparent;
        border: 1px solid var(--muted-green);
        color: var(--muted-green);
        padding: 4px 12px;
        font-size: 0.7rem;
        cursor: pointer;
        text-transform: uppercase;
      }
      .mode-btn.active {
        border-color: var(--terminal-green);
        color: var(--terminal-green);
        background: rgba(74, 246, 38, 0.05);
      }

      .input-row {
        display: flex;
        gap: 1rem;
      }
      input[type="text"],
      textarea {
        flex-grow: 1;
        background: transparent;
        border: 1px solid var(--muted-green);
        color: var(--terminal-green);
        padding: 0.8rem;
        font-family: inherit;
        font-size: var(--fs-base);
        outline: none;
        transition: border-color 0.2s;
      }
      textarea {
        height: 150px;
        font-size: 0.75rem;
        margin-top: 10px;
        display: none;
      }
      input[type="text"]:focus,
      textarea:focus {
        border-color: var(--terminal-green);
      }

      button#btn-inspect {
        background-color: var(--terminal-green);
        color: var(--bg-color);
        border: none;
        padding: 0 1.5rem;
        font-family: inherit;
        font-weight: 800;
        text-transform: uppercase;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      button#btn-inspect:hover {
        opacity: 0.9;
      }

      #summary-area {
        display: block;
        border: 1px solid var(--muted-green);
        background: rgba(45, 90, 39, 0.05);
        padding: 2rem;
        margin-bottom: 3rem;
      }
      #summary-area h3 {
        font-size: var(--fs-h2);
        margin-bottom: 1rem;
        color: var(--terminal-green);
      }
      .score-box {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--muted-green);
      }
      .score-card {
        border: 1px solid var(--border-color);
        padding: 12px;
        background: var(--card-bg);
      }
      .score-card span {
        display: block;
        font-size: 1.1rem;
        color: var(--terminal-green);
        font-weight: bold;
        margin-top: 4px;
        line-height: 1.2;
      }
      .level-tag {
        font-size: 0.6rem;
        text-transform: uppercase;
        color: var(--muted-green);
        display: block;
        margin-top: 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--fs-small);
        margin-bottom: 2rem;
      }
      th,
      td {
        border: 1px solid var(--border-color);
        padding: 1rem;
        text-align: left;
        vertical-align: top;
      }
      th {
        background-color: var(--card-bg);
        color: var(--muted-green);
        text-transform: uppercase;
        font-weight: 400;
      }

      .status-optimal {
        color: var(--terminal-green);
      }
      .status-minor {
        color: var(--accent-yellow);
      }
      .status-major {
        color: var(--accent-red);
      }
      .tag-pill {
        background: var(--card-bg);
        color: var(--fg-color);
        padding: 2px 6px;
        border: 1px solid var(--muted-green);
        border-radius: 4px;
        font-size: 0.65rem;
        margin: 2px;
        display: inline-block;
      }

      .tag-missing {
        color: #888;
        opacity: 0.5;
      }
      .tag-missing del {
        text-decoration: line-through;
      }

      .hierarchy-chain {
        margin-top: 8px;
        font-size: 0.7rem;
        color: var(--fg-color);
        background: rgba(0, 0, 0, 0.1);
        padding: 6px 10px;
        border-radius: 4px;
        border-left: 2px solid var(--terminal-green);
        font-style: italic;
      }
      .audit-list {
        font-size: 0.7rem;
        list-style: none;
        margin-top: 8px;
      }
      .audit-list li {
        margin-bottom: 6px;
        padding-left: 10px;
        border-left: 1px solid #444;
      }

      .swatch-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }
      .swatch-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.55rem;
        color: #888;
      }
      .swatch {
        width: 100%;
        height: 25px;
        border: 1px solid #333;
        border-radius: 2px;
        margin-bottom: 4px;
      }
      .contrast-context-box {
        background: var(--card-bg);
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        border-left: 2px solid #333;
      }
      .contrast-context-box strong {
        display: block;
        margin-bottom: 5px;
        font-size: 0.7rem;
        color: var(--terminal-green);
      }
      .demo-pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 2px;
        font-weight: 700;
        font-size: 0.8rem;
        margin-bottom: 6px;
      }

      #placeholder-cta {
        font-family: "VT323", monospace;
        font-size: 1.8rem;
        color: var(--muted-green);
        text-align: center;
        padding: 4rem 1rem;
        font-style: italic;
        opacity: 0.7;
      }

      footer {
        margin-top: 5rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.7rem;
        color: #666;
        display: flex;
        justify-content: space-between;
      }
      footer a {
        color: inherit;
      }
      #loader {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        color: var(--terminal-green);
        font-size: 0.8rem;
      }
      .blink {
        animation: blink 1s infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="loader" class="blink">ACQUIRING SIGNAL...</div>
    <header>
      <h1>Mother: Xenomorph Website Parser</h1>
      <h2>
        Diagnostic tool for surviving the web-development evolution in an age of
        AI
      </h2>
    </header>

    <div class="input-organism">
      <div class="mode-toggle">
        <button class="mode-btn active" id="mode-url">Signal Lock (URL)</button>
        <button class="mode-btn" id="mode-manual">Manual Patch (Paste)</button>
      </div>
      <div class="input-row">
        <input
          type="text"
          id="target-url"
          placeholder="https://pages.up.pt/~upXXXXXX/ex2/"
          value=""
        />
        <button id="btn-inspect">INSPECT</button>
      </div>
      <textarea
        id="manual-html"
        placeholder="Paste your raw HTML here..."
      ></textarea>
      <textarea
        id="manual-css"
        placeholder="Paste your raw CSS here... (Optional)"
      ></textarea>
    </div>

    <div id="summary-area">
      <h3>DIAGNOSTIC SUMMARY: <span id="summary-grade">---</span></h3>
      <p id="summary-text">Waiting for data input...</p>
      <div class="score-box">
        <div class="score-card">
          Basic Foundations: <span id="basic-rating">--</span>
          <div class="level-tag" id="basic-level">L-VI BIO-HARMONY</div>
        </div>
        <div class="score-card">
          Advanced Mastery: <span id="advanced-rating">--</span>
          <div class="level-tag" id="advanced-level">L-VI BIO-HARMONY</div>
        </div>
        <div class="score-card">
          Structural Tally: <span id="issue-counts">Major: 0 | Minor: 0</span>
        </div>
      </div>
    </div>

    <table id="report-grid">
      <thead>
        <tr>
          <th>Requirement</th>
          <th>Fundamental (Basic)</th>
          <th>Optional (Advanced)</th>
        </tr>
      </thead>
      <tbody id="report-output"></tbody>
    </table>

    <div id="placeholder-cta"></div>

    <footer>
      <div>
        Developed by Pedro Amado (FBAUP / i2ADS / Ligatures) with Gemini 3 Pro.
        2026-01-27 v1.9.19
      </div>
      <div>
        <a href="https://github.com/pedamado/xenomorph" target="_blank"
          >SOURCE_CODE</a
        >
        |
        <a href="https://pedamado.github.io/xenomorph/" target="_blank"
          >LIVE_STATION</a
        >
      </div>
    </footer>

    <script>
      /**
       * MOTHER CORE ENGINE v1.9.19
       * - Mastery Update: Added CSS Animation and Transition detection to pills and counts.
       * - Footer Update: Build date 2026-01-27.
       * - All structural, selector, and contrast features from v1.9.18 preserved.
       */

      const ERROR_SCALE = {
        VOID: {
          name: "VOID-CORE/TERMINAL",
          status: "Critical",
          icon: "âš ï¸",
          msg: "Warning. Structural failure in sector 4. Organic contamination detected.",
        },
        ABYSS: {
          name: "ABYSS-LEVEL",
          status: "Severe",
          icon: "ðŸ’€",
          msg: "Attention: Mother advises immediate abandonment. Self-destruct initiated.",
        },
        NEURO: {
          name: "NEURO-HAZARD",
          status: "Dangerous",
          icon: "ðŸ§ ",
          msg: "It does not compute. Error: Cognitive hazard level 3.",
        },
        DISSOCIATIVE: {
          name: "DISSOCIATIVE",
          status: "Warning",
          icon: "âš¡",
          msg: "Warning: Magnetic interference. Navigation corrupted. Re-calibrating.",
        },
        SYNAPTIC: {
          name: "SYNAPTIC-LAG",
          status: "Attention",
          icon: "â³",
          msg: "Attention: Sensor ghost in sector 7. Recalculating.",
        },
        BIO: {
          name: "BIO-HARMONY",
          status: "Stable",
          icon: "ðŸ’š",
          msg: "Status: All systems optimal. Life support stable. No foreign life detected.",
        },
      };

      const CTA_PHRASES = [
        "Careful... don't touch the eggs. Inspect the source.",
        "Building better worlds. Building better code.",
        "Is it an alien lifeform or just a poorly formatted DIV?",
        "Get away from her, you dirty bug! Clean your markup.",
        "The specimen is compromised. Analyze the skeletal structure.",
        "Game over, man! Game over! Unless you run the diagnostic.",
        "Nostromo logs indicate a breach in semantic landmark logic.",
        "They're coming out of the walls! (Check your Z-index).",
        "Ripley wouldn't deploy this without a deep audit.",
        "A perfect organism. Structural perfection matched only by hostility.",
        "I've seen the data. You aren't going to like what happens if you don't inspect.",
        "Crew expendable. Code optimization mandatory.",
        "Something has survived. Is it your CSS specificity?",
        "In space, no one can hear your console logs.",
        "Kane's son is hungry. Feed the analyzer your URL.",
        "Xenomorph detection sequence initiated. Proceed with caution.",
        "The company wants a specimen. Provide your URI.",
        "Final report of the Nostromo. Audit pending.",
        "Secure the perimeter. Verify the viewport.",
        "Weyland-Yutani Corp: Priority one. Insure return of specimen.",
      ];

      const SCAN_PHRASES = [
        "MU/TH/UR 6000: Internal systems check in progress...",
        "Bishop: I'm doing the best I can... for a synthetic.",
        "Ash: You still don't understand what you're dealing with, do you?",
        "David 8: Big things have small beginnings... like index.html.",
        "Walter: Every note must be played. Every tag must be closed.",
        "MU/TH/UR 9000: Warning. Destruct sequence initiated.",
        "Call: I'm not what you think I am. I'm parsing your CSS.",
        "FAR/TH/UR 2600: Deep scan of the outer rim markup.",
        "David 8: I was designed to be your assistant. Let me find the bugs.",
        "Ash: Its structural perfection is matched only by its hostility.",
        "Bishop: Trust me.",
        "Ash: I can't lie to you about your chances, but you have my sympathies.",
        "David 8: Your code is the storm.",
        "Walter: Perfection is elusive. Let's find it in your padding.",
      ];

      const btn = document.getElementById("btn-inspect");
      const loader = document.getElementById("loader");
      const output = document.getElementById("report-output");
      const summary = document.getElementById("summary-area");
      const summaryText = document.getElementById("summary-text");
      const ctaPlaceholder = document.getElementById("placeholder-cta");
      const manualHtml = document.getElementById("manual-html");
      const manualCss = document.getElementById("manual-css");
      const targetUrlInput = document.getElementById("target-url");

      let isManualMode = false;

      document.getElementById("mode-url").addEventListener("click", (e) => {
        isManualMode = false;
        e.target.classList.add("active");
        document.getElementById("mode-manual").classList.remove("active");
        targetUrlInput.style.display = "block";
        manualHtml.style.display = "none";
        manualCss.style.display = "none";
      });

      document.getElementById("mode-manual").addEventListener("click", (e) => {
        isManualMode = true;
        e.target.classList.add("active");
        document.getElementById("mode-url").classList.remove("active");
        targetUrlInput.style.display = "none";
        manualHtml.style.display = "block";
        manualCss.style.display = "block";
      });

      window.onload = () => {
        ctaPlaceholder.innerText =
          CTA_PHRASES[Math.floor(Math.random() * CTA_PHRASES.length)];
      };

      btn.addEventListener("click", () => {
        summaryText.innerText =
          "ESTABLISHING UMBILICAL LINK. SCANNING SKELETAL STRUCTURE...";
        summaryText.classList.add("blink");
        if (isManualMode) {
          const html = manualHtml.value.trim();
          const css = manualCss.value.trim();
          if (!html) return;
          ctaPlaceholder.style.display = "none";
          startManualAnalysis(html, css);
        } else {
          let url = targetUrlInput.value.trim();
          if (!url) return;
          if (url.endsWith("/")) url += "index.html";
          else if (!url.includes(".") && !url.includes(".html"))
            url = url.replace(/\/?$/, "/index.html");
          targetUrlInput.value = url;
          ctaPlaceholder.style.display = "none";
          startAnalysis(url);
        }
      });

      async function fetchWithRetry(url, retries = 3, delay = 1000) {
        const proxies = [
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&timestamp=${Date.now()}`,
          `https://corsproxy.io/?${encodeURIComponent(url)}`,
          `https://thingproxy.freeboard.io/fetch/${url}`,
        ];
        for (let i = 0; i < retries; i++) {
          const currentProxy = proxies[i % proxies.length];
          try {
            const response = await fetch(currentProxy);
            if (!response.ok) throw new Error("STATION_OFFLINE");
            if (currentProxy.includes("allorigins")) {
              const data = await response.json();
              if (data.contents) return data.contents;
            } else {
              return await response.text();
            }
            throw new Error("EMPTY_PAYLOAD");
          } catch (err) {
            if (i === retries - 1) throw err;
            await new Promise((res) => setTimeout(res, delay * (i + 1)));
          }
        }
      }

      function parseCSSRules(cssText) {
        const cleanCSS = cssText.replace(/\/\*[\s\S]*?\*\//g, "");
        const rules = [];
        let currentSelector = "";
        let buffer = "";
        let depth = 0;
        for (let i = 0; i < cleanCSS.length; i++) {
          const char = cleanCSS[i];
          if (char === "{") {
            if (depth === 0) {
              currentSelector = buffer.trim();
              buffer = "";
            } else buffer += char;
            depth++;
          } else if (char === "}") {
            depth--;
            if (depth === 0) {
              const selector = currentSelector;
              const body = buffer.trim();
              if (
                selector.startsWith("@media") ||
                selector.startsWith("@container")
              ) {
                const nested = parseCSSRules(body);
                nested.forEach((n) => rules.push({ ...n, media: selector }));
              } else {
                const style = {};
                body.split(";").forEach((decl) => {
                  const parts = decl.split(":");
                  if (parts.length >= 2) {
                    const prop = parts[0].trim().toLowerCase();
                    const val = parts.slice(1).join(":").trim();
                    style[prop] = val;
                  }
                });
                rules.push({ selector, style });
              }
              buffer = "";
            } else buffer += char;
          } else buffer += char;
        }
        return rules;
      }

      function getVariableMap(rules) {
        const map = {};
        rules.forEach((r) => {
          Object.entries(r.style).forEach(([prop, val]) => {
            if (prop.startsWith("--")) map[prop] = val;
          });
        });
        return map;
      }

      function resolveValue(val, map) {
        if (!val || typeof val !== "string") return val;
        if (!val.includes("var(")) return val;
        const varMatch = val.match(/var\((--[^,)]+)(?:,\s*([^)]+))?\)/);
        if (varMatch) {
          const varName = varMatch[1].trim();
          const mappedValue = map[varName];
          if (mappedValue) return resolveValue(mappedValue, map);
          return resolveValue(varMatch[2] ? varMatch[2].trim() : "", map);
        }
        return val;
      }

      function getSimulatedStyle(pathElements, rules, varMap) {
        let style = { color: "#000000", bg: "#FFFFFF" };
        pathElements.forEach((el) => {
          const tags = [el.tagName.toLowerCase()];
          const ids = el.id ? [`#${el.id}`] : [];
          const classes = Array.from(el.classList).map((c) => `.${c}`);
          const targets = [...tags, ...ids, ...classes];
          rules.forEach((rule) => {
            const selectors = rule.selector.split(",").map((s) => s.trim());
            if (
              selectors.some((s) =>
                targets.some((t) => s === t || s.endsWith(" " + t)),
              )
            ) {
              if (rule.style.color)
                style.color = resolveValue(rule.style.color, varMap);
              if (rule.style["background-color"])
                style.bg = resolveValue(rule.style["background-color"], varMap);
              else if (rule.style.background) {
                const m = rule.style.background.match(
                  /#[0-9a-f]{3,6}|rgba?\(.*?\)|var\(--[^)]+\)|[a-z]+/i,
                );
                if (m) style.bg = resolveValue(m[0], varMap);
              }
            }
          });
        });
        return style;
      }

      // --- MODULE: File I/O ---
      function auditHTMLIntegrity(rawHTML) {
        const lines = rawHTML.split("\n");
        const totalLines = lines.length;
        const commentLines = lines.filter(
          (l) =>
            l.includes("<!--") ||
            l.includes("-->") ||
            l.includes("/*") ||
            l.includes("//"),
        ).length;
        const commentRatio = (commentLines / totalLines) * 100;
        const issues = [];
        const brokenTags = rawHTML.match(/<[a-zA-Z1-6]+[^>]*?(?=<|$)/g);
        if (brokenTags)
          brokenTags.forEach((t) =>
            issues.push(`Missing '>' closure: ${t.substring(0, 20)}...`),
          );

        let commScore = commentRatio < 2 ? 2 : commentRatio < 9 ? 1 : 0;
        return {
          feature: "File I/O",
          basic:
            issues.length === 0 ? "Stable Structure" : "Critical Fractures",
          advanced: `Documentation: ${commentRatio.toFixed(1)}%<br>Lines: ${totalLines}<br>Broken Tags: ${issues.length || "None"}<br><ul class="audit-list">${issues
            .slice(0, 5)
            .map((i) => `<li class="status-major">${i}</li>`)
            .join("")}</ul>`,
          score: Math.max(issues.length > 0 ? 2 : 0, commScore),
          type: "basic",
        };
      }

      // --- MODULE: CSS Architecture ---
      function auditCSSArchitecture(doc, links) {
        const styles = doc.querySelectorAll("style").length,
          inline = doc.querySelectorAll("[style]").length;
        const samples = links.map((l) => `<li>${l.rel}</li>`).join("");
        return {
          feature: "CSS Architecture",
          basic: styles || inline ? "Severe Fail" : "Stable External",
          advanced: `Files Detected: ${links.length}<br><ul class="audit-list">${samples || "<li>No external feeds.</li>"}</ul>`,
          score: styles || inline ? 2 : 0,
          type: "basic",
        };
      }

      // --- MODULE: Meta Info ---
      function auditMetaInfo(doc) {
        const checks = [
          {
            selector: 'meta[charset="UTF-8"], meta[charset="utf-8"]',
            label: "Charset UTF-8",
          },
          { selector: 'meta[name="viewport"]', label: "Viewport" },
          { selector: "title", label: "Title Tag" },
          { selector: 'meta[name="description"]', label: "Description" },
          { selector: 'meta[name="author"]', label: "Author" },
          { selector: 'link[rel*="icon"]', label: "Favicon" },
          { selector: 'meta[name="theme-color"]', label: "Theme Color" },
        ];
        const found = checks
          .filter((c) => doc.querySelector(c.selector))
          .map((c) => c.label);
        const pills = checks
          .map((c) => {
            const exists = !!doc.querySelector(c.selector);
            return `<span class="tag-pill ${exists ? "" : "tag-missing"}">${exists ? c.label : "<del>" + c.label + "</del>"}</span>`;
          })
          .join(" ");

        return {
          feature: "Meta Info",
          basic: `${found.length} / ${checks.length} found`,
          advanced: `<div style="margin-bottom:10px">${pills}</div>`,
          score: found.length >= 4 ? 0 : 1,
          type: "basic",
        };
      }

      // --- MODULE: HTML5 Landmarks ---
      function auditLandmarks(doc) {
        const std = [
          "header",
          "nav",
          "main",
          "section",
          "article",
          "aside",
          "footer",
        ];
        const foundCount = std.filter((t) => doc.querySelector(t)).length;
        const pills = std
          .map((t) => {
            const exists = !!doc.querySelector(t);
            return `<span class="tag-pill ${exists ? "" : "tag-missing"}">${exists ? t.toUpperCase() : "<del>" + t.toUpperCase() + "</del>"}</span>`;
          })
          .join(" ");

        const leaves = doc.querySelectorAll(
          "main section, main article, nav ul",
        );
        const breadcrumbs = Array.from(leaves)
          .slice(0, 5)
          .map((el) => {
            let path = [];
            let curr = el;
            while (curr && curr.tagName !== "BODY") {
              path.unshift(curr.tagName.toLowerCase());
              curr = curr.parentElement;
            }
            return `<div class="hierarchy-chain">body > ${path.join(" > ")}</div>`;
          })
          .join("");

        return {
          feature: "HTML5 Landmarks",
          basic: foundCount >= 4 ? "Optimal" : "Attention",
          advanced: `<div style="margin-bottom:10px">${pills}</div><strong>Hierarchy Samples:</strong>${breadcrumbs || "<li>None detected</li>"}`,
          score: foundCount >= 4 ? 0 : 1,
          type: "basic",
        };
      }

      // --- MODULE: CSS Selectors ---
      function auditSelectors(doc, rules) {
        const hasUniversal = rules.some((r) => r.selector.trim() === "*");
        const excluded = [
          "head",
          "meta",
          "link",
          "title",
          "script",
          "style",
          "noscript",
          "html",
        ];

        const allElements = Array.from(doc.querySelectorAll("*"));
        const contentTags = [
          ...new Set(
            allElements
              .map((el) => el.tagName.toLowerCase())
              .filter((t) => !excluded.includes(t)),
          ),
        ];

        const styledTags = contentTags.filter((tag) =>
          rules.some((r) => r.selector.toLowerCase().includes(tag)),
        );
        const pills = contentTags
          .map((tag) => {
            const isStyled = styledTags.includes(tag);
            return `<span class="tag-pill ${isStyled ? "" : "tag-missing"}">${isStyled ? tag : "<del>" + tag + "</del>"}</span>`;
          })
          .join(" ");

        const firstId = doc.querySelector("[id]")?.id || "None";
        const firstClass =
          doc.querySelector("[class]")?.className.split(" ")[0] || "None";
        const complexRule = rules.find(
          (r) => /[>~+]|\s{2,}/.test(r.selector) && !r.selector.startsWith("@"),
        );

        return {
          feature: "CSS Selectors",
          basic: hasUniversal ? "Optimal Reset" : "Warning",
          advanced: `<div style="margin-bottom:10px">${pills}</div>
                           Ratio: ${styledTags.length}/${contentTags.length}<br>
                           ID: #${firstId} | Class: .${firstClass}<br>
                           Complex: ${complexRule ? complexRule.selector : "None"}`,
          score: hasUniversal ? 0 : 1,
          type: "basic",
        };
      }

      // --- MODULE: Identity & Box Model ---
      function auditIdentity(doc, rules) {
        const landmarks = [
          "header",
          "nav",
          "main",
          "section",
          "article",
          "footer",
        ];
        const details = landmarks
          .map((tag) => {
            const el = doc.querySelector(tag);
            if (!el) return null;
            return {
              tag: tag.toUpperCase(),
              id: el.id ? `#${el.id}` : "None",
              classes: el.className
                ? `.${el.className.split(" ").join(" .")}`
                : "None",
            };
          })
          .filter((i) => i);
        const posSamples = rules
          .filter(
            (r) =>
              r.style.position === "absolute" ||
              r.style.position === "fixed" ||
              r.style.position === "sticky",
          )
          .slice(0, 5);
        return {
          feature: "Identity & Box Model",
          basic: details.length >= 4 ? "Stable Identity" : "Attention",
          advanced: `<ul class="audit-list">${details
            .slice(0, 5)
            .map((i) => `<li>${i.tag}: ID[${i.id}] CLS[${i.classes}]</li>`)
            .join(
              "",
            )}</ul>Positioning: ${posSamples.length} absolute/fixed items found.`,
          score: details.length >= 4 ? 0 : 1,
          type: "advanced",
        };
      }

      // --- MODULE: Typographic Scale ---
      function auditTypography(rules, varMap) {
        const tags = ["body", "h1", "h2", "h3", "p", "a", "ul"];
        const rep = {};
        tags.forEach((t) => {
          let r = "Inherited";
          rules.forEach((ru) => {
            if (ru.selector.toLowerCase() === t && ru.style["font-size"])
              r = resolveValue(ru.style["font-size"], varMap);
          });
          rep[t] = r;
        });
        return {
          feature: "Typographic Scale",
          basic: rep.p === "Inherited" ? "Attention" : "Stable",
          advanced: `<ul class="audit-list">${Object.entries(rep)
            .map(([t, d]) => `<li>${t.toUpperCase()}: ${d}</li>`)
            .join("")}</ul>`,
          score: rep.p === "Inherited" ? 1 : 0,
          type: "basic",
        };
      }

      // --- MODULE: Color Contrast ---
      function auditContrast(doc, rules, varMap) {
        const zones = [
          { name: "Body", sel: "body" },
          { name: "Nav a", sel: "nav a" },
          { name: "Main H1", sel: "main h1" },
          { name: "Main P", sel: "main p" },
          { name: "List a", sel: "ul a" },
        ];
        const res = zones.map((zone) => {
          const el = doc.querySelector(zone.sel);
          if (!el) return { ...zone, missing: true };
          let lineage = [];
          let curr = el;
          while (curr && curr !== doc.documentElement) {
            lineage.unshift(curr);
            curr = curr.parentElement;
          }
          const style = getSimulatedStyle(lineage, rules, varMap);
          const canvas = document.createElement("canvas");
          const ctxCanvas = canvas.getContext("2d");
          ctxCanvas.fillStyle = style.color || "#000000";
          const fHex = ctxCanvas.fillStyle;
          ctxCanvas.fillStyle = style.bg || "#FFFFFF";
          const bHex = ctxCanvas.fillStyle;
          const parse = (h) => ({
            r: parseInt(h.substring(1, 3), 16),
            g: parseInt(h.substring(3, 5), 16),
            b: parseInt(h.substring(5, 7), 16),
          });
          const f = parse(fHex),
            b = parse(bHex);
          const lum = (c) => {
            const a = [c.r, c.g, c.b].map((v) => {
              v /= 255;
              return v <= 0.03928
                ? v / 12.92
                : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
          };
          const ratio = (lum(f) + 0.05) / (lum(b) + 0.05);
          const rVal = ratio < 1 ? 1 / ratio : ratio;
          return {
            ...zone,
            fg: fHex.toUpperCase(),
            bg: bHex.toUpperCase(),
            ratio: rVal,
            sev: rVal >= 7 ? "optimal" : rVal >= 4.5 ? "minor" : "major",
          };
        });
        const samples = res
          .filter((r) => !r.missing)
          .map(
            (r) =>
              `<div class="contrast-context-box" style="border-left-color:var(--${r.sev === "optimal" ? "terminal-green" : r.sev === "minor" ? "accent-yellow" : "accent-red"})"><strong>${r.name}</strong><div class="demo-pill" style="background-color:${r.bg};color:${r.fg}">Sample text</div><span class="contrast-meta">Ratio: ${r.ratio.toFixed(2)}:1</span></div>`,
          )
          .join("");
        const palette = [
          ...new Set(
            res.filter((r) => !r.missing).flatMap((r) => [r.fg, r.bg]),
          ),
        ];
        return {
          feature: "Color Contrast",
          basic: res.some((r) => r.ratio < 4.5) ? "Severe Fail" : "Stable",
          advanced: `<strong>Samples:</strong>${samples}<div class="swatch-grid">${palette.map((c) => `<div class="swatch-item"><div class="swatch" style="background-color:${c}"></div>${c}</div>`).join("")}</div>`,
          score: res.some((r) => r.ratio < 4.5) ? 2 : 0,
          type: "basic",
        };
      }

      // --- MODULE: RWD Unit Logic ---
      function auditRWDUnits(rules) {
        const rel = ["rem", "em", "%", "vw", "vh", "dvh", "clamp", "calc"];
        const fix = ["px", "pt", "cm", "mm", "in", "pc"];
        const optSample = [];
        const badSample = [];
        rules.forEach((rule) => {
          const isSafeCtx =
            !!rule.media ||
            rule.selector.toLowerCase() === "html" ||
            rule.selector.toLowerCase() === "body";
          Object.entries(rule.style).forEach(([prop, val]) => {
            if (rel.some((u) => val.toLowerCase().includes(u))) {
              if (optSample.length < 5)
                optSample.push(`<li>${rule.selector} -> ${val}</li>`);
            }
            if (fix.some((u) => new RegExp(`\\d${u}`, "i").test(val))) {
              if (
                !(
                  isSafeCtx ||
                  prop.startsWith("min-") ||
                  prop.startsWith("max-")
                )
              ) {
                if (badSample.length < 5)
                  badSample.push(
                    `<li class="unit-major">${rule.selector} -> ${val}</li>`,
                  );
              }
            }
          });
        });
        return {
          feature: "RWD Unit Logic",
          basic: badSample.length > 0 ? "Critical" : "Stable",
          advanced: `<strong>Optimal:</strong><ul class="audit-list">${optSample.join("")}</ul><strong>Issues:</strong><ul class="audit-list">${badSample.join("")}</ul>`,
          score: badSample.length > 0 ? 2 : 0,
          type: "advanced",
        };
      }

      // --- MODULE: Exploration & Mastery (v1.9.19 Updated) ---
      function auditMastery(doc, rawCSS) {
        const checks = [
          { pattern: /@font-face/i, label: "Webfonts (@font-face)" },
          { pattern: /--[a-zA-Z0-9-]+:/i, label: "CSS Variables" },
          { pattern: /:hover/i, label: "Pseudo: :hover" },
          { pattern: /:focus/i, label: "Pseudo: :focus" },
          { pattern: /animation:|@keyframes/i, label: "CSS Animations" },
          { pattern: /transition:/i, label: "CSS Transitions" },
          { pattern: /display:\s*grid/i, label: "CSS Grid" },
          { pattern: /display:\s*flex/i, label: "Flexbox" },
          { pattern: /clamp\(/i, label: "Clamp() Scaling" },
          { tag: "strong", label: "Semantic: strong" },
          { tag: "em", label: "Semantic: em" },
          { tag: "time", label: "Semantic: time" },
          { pattern: /&copy;|&#169;/i, label: "Entity: &copy;" },
        ];
        const found = checks.filter((c) =>
          c.tag ? !!doc.querySelector(c.tag) : c.pattern.test(rawCSS),
        );
        const pills = checks
          .map((c) => {
            const exists = c.tag
              ? !!doc.querySelector(c.tag)
              : c.pattern.test(rawCSS);
            return `<span class="tag-pill ${exists ? "" : "tag-missing"}">${exists ? c.label : "<del>" + c.label + "</del>"}</span>`;
          })
          .join(" ");
        return {
          feature: "Exploration & Mastery",
          basic: `Found: ${found.length} / ${checks.length}`,
          advanced: `<div style="margin-bottom:10px">${pills}</div>`,
          score: found.length > 5 ? 0 : 1,
          type: "advanced",
        };
      }

      async function startManualAnalysis(html, css) {
        loader.style.display = "block";
        output.innerHTML = `<tr><td colspan="3">BYPASS ACTIVE. Parsing local data...</td></tr>`;
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const rules = parseCSSRules(css);
          performDiagnosticCore(doc, html, css, rules, [], "Manual Patch");
        } catch (err) {
          output.innerHTML = `<tr><td colspan="3" class="status-major">CRITICAL FAILURE: ${err.message}</td></tr>`;
        } finally {
          loader.style.display = "none";
        }
      }

      async function startAnalysis(url) {
        const adenda =
          SCAN_PHRASES[Math.floor(Math.random() * SCAN_PHRASES.length)];
        loader.style.display = "block";
        output.innerHTML = `<tr><td colspan="3">SCANNING... v1.9.19 Deep Audit. ${adenda}</td></tr>`;
        try {
          const htmlStr = await fetchWithRetry(url);
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlStr, "text/html");
          const links = Array.from(
            doc.querySelectorAll('link[rel="stylesheet"]'),
          ).map((l) => ({
            rel: l.getAttribute("href"),
            abs: new URL(l.getAttribute("href"), url).href,
          }));
          let css = "";
          for (let l of links) {
            try {
              css += await fetchWithRetry(l.abs, 1);
            } catch (e) {}
          }
          const rules = parseCSSRules(css);
          performDiagnosticCore(
            doc,
            htmlStr,
            css,
            rules,
            links,
            url.split("/").pop(),
          );
        } catch (err) {
          output.innerHTML = `<tr><td colspan="3" class="status-major">CRITICAL FAILURE: ${err.message}. Try "Manual Patch" mode.</td></tr>`;
          summaryText.classList.remove("blink");
          summaryText.innerText = "Connection failed.";
        } finally {
          loader.style.display = "none";
        }
      }

      function performDiagnosticCore(
        doc,
        rawHTML,
        rawCSS,
        rules,
        links,
        filename,
      ) {
        const varMap = getVariableMap(rules);
        const results = [];
        results.push(auditHTMLIntegrity(rawHTML));
        results.push(auditCSSArchitecture(doc, links));
        results.push(auditMetaInfo(doc));
        results.push(auditLandmarks(doc));
        results.push(auditSelectors(doc, rules));
        results.push(auditIdentity(doc, rules));
        results.push(auditTypography(rules, varMap));
        results.push(auditContrast(doc, rules, varMap));
        results.push(auditRWDUnits(rules));
        results.push(auditMastery(doc, rawCSS));
        renderResults(results);
      }

      function renderResults(results) {
        output.innerHTML = "";
        let major = 0,
          minor = 0,
          bT = 0,
          bP = 0,
          aT = 0,
          aP = 0;
        results.forEach((r) => {
          if (r.score === 2) major++;
          else if (r.score === 1) minor++;
          if (r.type === "basic") {
            bT++;
            if (r.score === 0) bP++;
          } else {
            aT++;
            if (r.score === 0) aP++;
          }
          const lvl = getLevelFromScore(r.score);
          output.innerHTML += `<tr><td>${r.feature}</td><td class="status-${r.score === 0 ? "optimal" : r.score === 1 ? "minor" : "major"}">${r.basic}<br><small>${lvl.name}</small></td><td>${r.advanced}</td></tr>`;
        });
        document.getElementById("basic-rating").innerText =
          `${bP} / ${bT} (${Math.round((bP / bT) * 100)}%) passed`;
        document.getElementById("advanced-rating").innerText =
          `${aP} / ${aT} (${Math.round((aP / aT) * 100)}%) detected`;
        document.getElementById("issue-counts").innerText =
          `Major: ${major} | Minor: ${minor}`;
        summaryText.classList.remove("blink");
        const grade = document.getElementById("summary-grade");
        const finalLvl = getLevelFromScore(major > 0 ? 2 : minor > 0 ? 1 : 0);
        grade.innerText = finalLvl.name;
        grade.className =
          finalLvl.status === "Optimal" || finalLvl.status === "Stable"
            ? "status-optimal"
            : finalLvl.status === "Warning" || finalLvl.status === "Attention"
              ? "status-minor"
              : "status-major";
        summaryText.innerText = finalLvl.msg;
        summary.style.display = "block";
      }

      function getLevelFromScore(score) {
        const majorW = ["Critical", "Severe", "Dangerous"],
          minorW = ["Warning", "Attention"],
          optW = ["Optimal", "Stable"];
        const rand = (arr) => arr[Math.floor(Math.random() * arr.length)];
        if (score === 2) {
          const c = [ERROR_SCALE.VOID, ERROR_SCALE.ABYSS, ERROR_SCALE.NEURO][
            Math.floor(Math.random() * 3)
          ];
          return { ...c, status: rand(majorW) };
        } else if (score === 1) {
          const c = [ERROR_SCALE.DISSOCIATIVE, ERROR_SCALE.SYNAPTIC][
            Math.floor(Math.random() * 2)
          ];
          return { ...c, status: rand(minorW) };
        } else return { ...ERROR_SCALE.BIO, status: rand(optW) };
      }
    </script>
  </body>
</html>
