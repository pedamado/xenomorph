<!doctype html>
<html lang="pt-PT">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mother: Xenomorph Website Parser</title>
    <!-- JetBrains Mono & VT323 Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      /* XenoMorph Design System: "Mother" Aesthetic */
      :root {
        --smoke-black: #0d0d0d;
        --off-white: #f5f5f5;
        --terminal-green: #4af626;
        --muted-green: #2d5a27;
        --accent-red: #ff4d4d;
        --accent-yellow: #ffcc00;

        --bg-color: var(--smoke-black);
        --fg-color: var(--off-white);
        --border-color: #222;
        --card-bg: #111;
        --fs-base: 1rem;
        --fs-h2: 1.25rem;
        --fs-h1: 1.563rem;
        --fs-small: 0.8rem;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg-color: var(--off-white);
          --fg-color: var(--smoke-black);
          --border-color: #ddd;
          --card-bg: #fff;
          --terminal-green: #1c8b1c;
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        background-color: var(--bg-color);
        color: var(--fg-color);
        font-family: "JetBrains Mono", monospace;
        line-height: 1.6;
        padding: 2.5rem;
        min-height: 100dvh;
        transition:
          background-color 0.3s,
          color 0.3s;
      }
      header {
        border-bottom: 2px solid var(--terminal-green);
        padding-bottom: 1.5rem;
        margin-bottom: 3rem;
        position: relative;
      }
      header::after {
        content: "MU-TH-UR 6000 SYSTEM ONLINE";
        position: absolute;
        bottom: -25px;
        right: 0;
        font-size: 0.7rem;
        color: var(--muted-green);
      }
      h1 {
        font-size: var(--fs-h1);
        color: var(--terminal-green);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 0.5rem;
      }
      h2 {
        font-size: var(--fs-h2);
        color: var(--fg-color);
        font-weight: 300;
        opacity: 0.8;
      }

      .input-organism {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 4rem;
        max-width: 800px;
      }
      .mode-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
      }
      .mode-btn {
        background: transparent;
        border: 1px solid var(--muted-green);
        color: var(--muted-green);
        padding: 4px 12px;
        font-size: 0.7rem;
        cursor: pointer;
        text-transform: uppercase;
      }
      .mode-btn.active {
        border-color: var(--terminal-green);
        color: var(--terminal-green);
        background: rgba(74, 246, 38, 0.05);
      }

      .input-row {
        display: flex;
        gap: 1rem;
      }
      input[type="text"],
      textarea {
        flex-grow: 1;
        background: transparent;
        border: 1px solid var(--muted-green);
        color: var(--terminal-green);
        padding: 0.8rem;
        font-family: inherit;
        font-size: var(--fs-base);
        outline: none;
        transition: border-color 0.2s;
      }
      textarea {
        height: 150px;
        font-size: 0.75rem;
        margin-top: 10px;
        display: none;
      }
      input[type="text"]:focus,
      textarea:focus {
        border-color: var(--terminal-green);
      }

      button#btn-inspect {
        background-color: var(--terminal-green);
        color: var(--bg-color);
        border: none;
        padding: 0 1.5rem;
        font-family: inherit;
        font-weight: 800;
        text-transform: uppercase;
        cursor: pointer;
        transition: opacity 0.2s;
      }
      button#btn-inspect:hover {
        opacity: 0.9;
      }

      #summary-area {
        display: none;
        border: 1px solid var(--muted-green);
        background: rgba(45, 90, 39, 0.05);
        padding: 2rem;
        margin-bottom: 3rem;
      }
      #summary-area h3 {
        font-size: var(--fs-h2);
        margin-bottom: 1rem;
        color: var(--terminal-green);
      }
      .score-box {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid var(--muted-green);
      }
      .score-card {
        border: 1px solid var(--border-color);
        padding: 12px;
        background: var(--card-bg);
      }
      .score-card span {
        display: block;
        font-size: 1.2rem;
        color: var(--terminal-green);
        font-weight: bold;
        margin-top: 4px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: var(--fs-small);
        margin-bottom: 2rem;
      }
      th,
      td {
        border: 1px solid var(--border-color);
        padding: 1rem;
        text-align: left;
        vertical-align: top;
      }
      th {
        background-color: var(--card-bg);
        color: var(--muted-green);
        text-transform: uppercase;
        font-weight: 400;
      }

      .status-optimal {
        color: var(--terminal-green);
      }
      .status-minor {
        color: var(--accent-yellow);
      }
      .status-major {
        color: var(--accent-red);
      }
      .tag-pill {
        background: var(--card-bg);
        color: var(--fg-color);
        padding: 2px 6px;
        border: 1px solid var(--muted-green);
        border-radius: 4px;
        font-size: 0.65rem;
        margin: 2px;
        display: inline-block;
      }

      .tag-missing {
        color: #888;
        opacity: 0.5;
      }
      .tag-missing del {
        text-decoration: line-through;
      }

      .hierarchy-chain {
        margin-top: 8px;
        font-size: 0.7rem;
        color: var(--fg-color);
        background: rgba(0, 0, 0, 0.1);
        padding: 6px 10px;
        border-radius: 4px;
        border-left: 2px solid var(--terminal-green);
        font-style: italic;
      }
      .audit-list {
        font-size: 0.7rem;
        list-style: none;
        margin-top: 8px;
      }
      .audit-list li {
        margin-bottom: 6px;
        padding-left: 10px;
        border-left: 1px solid #444;
      }

      .swatch-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }
      .swatch-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0.55rem;
        color: #888;
      }
      .swatch {
        width: 100%;
        height: 25px;
        border: 1px solid #333;
        border-radius: 2px;
        margin-bottom: 4px;
      }
      .contrast-context-box {
        background: var(--card-bg);
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        border-left: 2px solid #333;
      }
      .contrast-context-box strong {
        display: block;
        margin-bottom: 5px;
        font-size: 0.7rem;
        color: var(--terminal-green);
      }
      .demo-pill {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 2px;
        font-weight: 700;
        font-size: 0.8rem;
        margin-bottom: 6px;
      }

      #placeholder-cta {
        font-family: "VT323", monospace;
        font-size: 1.8rem;
        color: var(--muted-green);
        text-align: center;
        padding: 4rem 1rem;
        font-style: italic;
        opacity: 0.7;
      }

      footer {
        margin-top: 5rem;
        padding-top: 2rem;
        border-top: 1px solid var(--border-color);
        font-size: 0.7rem;
        color: #666;
        display: flex;
        justify-content: space-between;
      }
      footer a {
        color: inherit;
      }
      #loader {
        display: none;
        position: fixed;
        top: 20px;
        right: 20px;
        color: var(--terminal-green);
        font-size: 0.8rem;
      }
      .blink {
        animation: blink 1s infinite;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="loader" class="blink">ACQUIRING SIGNAL...</div>
    <header>
      <h1>Mother: Xenomorph Website Parser</h1>
      <h2>
        Diagnostic tool for surviving the web-development evolution in an age of
        AI
      </h2>
    </header>

    <div class="input-organism">
      <div class="mode-toggle">
        <button class="mode-btn active" id="mode-url">Signal Lock (URL)</button>
        <button class="mode-btn" id="mode-manual">Manual Patch (Paste)</button>
      </div>
      <div class="input-row">
        <input
          type="text"
          id="target-url"
          placeholder="https://pages.up.pt/~upXXXXXX/ex2/"
          value=""
        />
        <button id="btn-inspect">INSPECT</button>
      </div>
      <textarea
        id="manual-html"
        placeholder="Paste your raw HTML here..."
      ></textarea>
      <textarea
        id="manual-css"
        placeholder="Paste your raw CSS here... (Optional)"
      ></textarea>
    </div>

    <div id="summary-area">
      <h3>DIAGNOSTIC SUMMARY: <span id="summary-grade">---</span></h3>
      <p id="summary-text">Waiting for data input...</p>
      <div class="score-box">
        <div class="score-card">
          Basic Foundations: <span id="basic-rating">0%</span>
        </div>
        <div class="score-card">
          Advanced Techniques: <span id="advanced-rating">0%</span>
        </div>
        <div class="score-card">
          Issue Tally: <span id="issue-counts">Major: 0 | Minor: 0</span>
        </div>
      </div>
    </div>

    <table id="report-grid">
      <thead>
        <tr>
          <th>Feature / Requirement</th>
          <th>Fundamental (Basic)</th>
          <th>Optional (Advanced)</th>
        </tr>
      </thead>
      <tbody id="report-output"></tbody>
    </table>

    <div id="placeholder-cta"></div>

    <footer>
      <div>
        Developed by Pedro Amado (FBAUP / i2ADS / Ligatures) with Gemini 3 Pro.
        v1.9.6
      </div>
      <div>
        <a href="https://github.com/pedamado/xenomorph" target="_blank"
          >SOURCE_CODE</a
        >
        |
        <a href="https://pedamado.github.io/xenomorph/" target="_blank"
          >LIVE_STATION</a
        >
      </div>
    </footer>

    <script>
      /**
       * MOTHER CORE ENGINE v1.9.6
       * - Refined Color Contrast: Supports shorthand 'background' and named colors.
       * - Identity Audit: Checks for Classes and IDs in landmarks.
       * - Albert Kapr Personality: Thematic references in scan messages.
       */

      const CTA_PHRASES = [
        "Careful... don't touch the eggs. Inspect the source.",
        "Building better worlds. Building better code.",
        "Is it an alien lifeform or just a poorly formatted DIV?",
        "Get away from her, you dirty bug! Clean your markup.",
        "The specimen is compromised. Analyze the skeletal structure.",
        "Game over, man! Game over! Unless you run the diagnostic.",
        "Nostromo logs indicate a breach in semantic landmark logic.",
        "They're coming out of the walls! (Check your Z-index).",
        "Ripley wouldn't deploy this without a deep audit.",
        "A perfect organism. Structural perfection matched only by hostility.",
        "I've seen the data. You aren't going to like what happens if you don't inspect.",
        "Crew expendable. Code optimization mandatory.",
        "Something has survived. Is it your CSS specificity?",
        "In space, no one can hear your console logs.",
        "Kane's son is hungry. Feed the analyzer your URL.",
        "Xenomorph detection sequence initiated. Proceed with caution.",
        "The company wants a specimen. Provide your URI.",
        "Final report of the Nostromo. Audit pending.",
        "Secure the perimeter. Verify the viewport.",
        "Weyland-Yutani Corp: Priority one. Insure return of specimen.",
      ];

      const SCAN_PHRASES = [
        "MU/TH/UR 6000: Internal systems check in progress...",
        "Bishop: I'm doing the best I can... for a synthetic.",
        "Ash: You still don't understand what you're dealing with, do you?",
        "David 8: Big things have small beginnings... like index.html.",
        "Walter: Every note must be played. Every tag must be closed.",
        "MU/TH/UR 9000: Warning. Destruct sequence initiated.",
        "Call: I'm not what you think I am. I'm parsing your CSS.",
        "FAR/TH/UR 2600: Deep scan of the outer rim markup.",
        "David 8: I was designed to be your assistant. Let me find the bugs.",
        "Ash: Its structural perfection is matched only by its hostility.",
        "Bishop: Trust me.",
        "Ash: I can't lie to you about your chances, but you have my sympathies.",
        "David 8: Your code is the storm.",
        "Walter: Perfection is elusive. Let's find it in your padding.",
        "Bishop: Analyzing the 'History and Anatomy' of your letterforms. Albert Kapr would be proud of this skeletal logic.",
        "Ash: I admire its purity. A survivor... unlike your unclosed tags.",
        "David 8: I suppose I am a bit of a bibliophile for clean syntax.",
        "MU/TH/UR: Cross-referencing Kapr's 'Art of Lettering' with your font-stacks. Inspecting anatomical junctions.",
        "Bishop: My diagnostics indicate a 94% chance of structural integrity if you fix the margins.",
        "Walter: I am Walter. I check the anatomy. You provide the intent.",
      ];

      const btn = document.getElementById("btn-inspect");
      const loader = document.getElementById("loader");
      const output = document.getElementById("report-output");
      const summary = document.getElementById("summary-area");
      const ctaPlaceholder = document.getElementById("placeholder-cta");
      const manualHtml = document.getElementById("manual-html");
      const manualCss = document.getElementById("manual-css");
      const targetUrlInput = document.getElementById("target-url");

      let isManualMode = false;

      document.getElementById("mode-url").addEventListener("click", (e) => {
        isManualMode = false;
        e.target.classList.add("active");
        document.getElementById("mode-manual").classList.remove("active");
        targetUrlInput.style.display = "block";
        manualHtml.style.display = "none";
        manualCss.style.display = "none";
      });

      document.getElementById("mode-manual").addEventListener("click", (e) => {
        isManualMode = true;
        e.target.classList.add("active");
        document.getElementById("mode-url").classList.remove("active");
        targetUrlInput.style.display = "none";
        manualHtml.style.display = "block";
        manualCss.style.display = "block";
      });

      window.onload = () => {
        ctaPlaceholder.innerText =
          CTA_PHRASES[Math.floor(Math.random() * CTA_PHRASES.length)];
      };

      btn.addEventListener("click", () => {
        if (isManualMode) {
          const html = manualHtml.value.trim();
          const css = manualCss.value.trim();
          if (!html) return;
          ctaPlaceholder.style.display = "none";
          startManualAnalysis(html, css);
        } else {
          let url = targetUrlInput.value.trim();
          if (!url) return;
          if (url.endsWith("/")) url += "index.html";
          else if (!url.includes(".") && !url.includes(".html"))
            url = url.replace(/\/?$/, "/index.html");
          targetUrlInput.value = url;
          ctaPlaceholder.style.display = "none";
          startAnalysis(url);
        }
      });

      async function fetchWithRetry(url, retries = 3, delay = 1000) {
        const proxies = [
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&timestamp=${Date.now()}`,
          `https://corsproxy.io/?${encodeURIComponent(url)}`,
          `https://thingproxy.freeboard.io/fetch/${url}`,
        ];
        for (let i = 0; i < retries; i++) {
          const currentProxy = proxies[i % proxies.length];
          try {
            const response = await fetch(currentProxy);
            if (!response.ok) throw new Error("STATION_OFFLINE");
            if (currentProxy.includes("allorigins")) {
              const data = await response.json();
              if (data.contents) return data.contents;
            } else {
              return await response.text();
            }
            throw new Error("EMPTY_PAYLOAD");
          } catch (err) {
            if (i === retries - 1) throw err;
            await new Promise((res) => setTimeout(res, delay * (i + 1)));
          }
        }
      }

      function parseCSSRules(cssText) {
        const cleanCSS = cssText.replace(/\/\*[\s\S]*?\*\//g, "");
        const rules = [];
        let currentSelector = "";
        let buffer = "";
        let depth = 0;
        for (let i = 0; i < cleanCSS.length; i++) {
          const char = cleanCSS[i];
          if (char === "{") {
            if (depth === 0) {
              currentSelector = buffer.trim();
              buffer = "";
            } else buffer += char;
            depth++;
          } else if (char === "}") {
            depth--;
            if (depth === 0) {
              const selector = currentSelector;
              const body = buffer.trim();
              if (
                selector.startsWith("@media") ||
                selector.startsWith("@container")
              ) {
                const nested = parseCSSRules(body);
                nested.forEach((n) => rules.push({ ...n, media: selector }));
              } else {
                const style = {};
                body.split(";").forEach((decl) => {
                  const parts = decl.split(":");
                  if (parts.length >= 2) {
                    const prop = parts[0].trim().toLowerCase();
                    const val = parts.slice(1).join(":").trim();
                    style[prop] = val;
                  }
                });
                rules.push({ selector, style });
              }
              buffer = "";
            } else buffer += char;
          } else buffer += char;
        }
        return rules;
      }

      // --- MODULE: Meta Info ---
      function auditMetaInfo(doc) {
        const checks = [
          {
            selector: 'meta[charset="UTF-8"], meta[charset="utf-8"]',
            label: "Charset UTF-8",
          },
          { selector: 'meta[name="viewport"]', label: "Viewport" },
          { selector: "title", label: "Title Tag" },
          { selector: 'meta[name="description"]', label: "Description" },
          { selector: 'meta[name="author"]', label: "Author" },
          { selector: 'link[rel*="icon"]', label: "Favicon" },
          { selector: 'meta[name="theme-color"]', label: "Theme Color" },
        ];
        const found = checks
          .filter((c) => doc.querySelector(c.selector))
          .map((c) => c.label);
        const missing = checks
          .filter((c) => !doc.querySelector(c.selector))
          .map((c) => c.label);
        return {
          feature: "Meta Info",
          basic: found.length >= 4 ? "Optimal" : "Minor Issue",
          advanced: `<strong>Checklist:</strong><ul class="audit-list">${found.map((l) => `<li class="status-optimal">${l}</li>`).join("")}${missing.map((l) => `<li class="tag-missing"><del>${l}</del></li>`).join("")}</ul>`,
          score: found.length >= 4 ? 0 : 1,
          type: "basic",
        };
      }

      function auditCSSSelectors(doc, rules) {
        const hasUniversal = rules.some((r) => r.selector.trim() === "*");
        const landmarks = [
          "html",
          "body",
          "header",
          "nav",
          "main",
          "section",
          "footer",
        ];
        const inCSS = landmarks.filter((l) =>
          rules.some((r) => r.selector.toLowerCase().includes(l)),
        );
        const excluded = [
          "head",
          "meta",
          "link",
          "title",
          "script",
          "style",
          "noscript",
        ];
        const allTags = [
          ...new Set(
            Array.from(doc.querySelectorAll("*"))
              .map((el) => el.tagName.toLowerCase())
              .filter((t) => !excluded.includes(t)),
          ),
        ];
        const matched = allTags.filter((tag) =>
          rules.some((r) => r.selector.toLowerCase().includes(tag)),
        );
        return {
          feature: "CSS Selectors",
          basic: hasUniversal
            ? "Optimal: Universal * found"
            : "Minor: No Universal reset",
          advanced: `<strong>Ratio: ${matched.length} / ${allTags.length}</strong><br>Landmarks in CSS: ${inCSS.length}/${landmarks.length}<br>Missing (Top 10): ${allTags
            .filter((t) => !matched.includes(t))
            .slice(0, 10)
            .map((m) => `<span class="tag-pill tag-missing">${m}</span>`)
            .join(" ")}`,
          score: hasUniversal && inCSS.length > 4 ? 0 : 1,
          type: "basic",
        };
      }

      // --- MODULE: Identity & Box Model (v1.9.6 Enhanced) ---
      function auditIdentity(doc, rules) {
        const landmarks = [
          "header",
          "nav",
          "main",
          "section",
          "article",
          "footer",
        ];
        const landmarkDetails = landmarks
          .map((tag) => {
            const el = doc.querySelector(tag);
            if (!el) return null;
            return {
              tag: tag.toUpperCase(),
              id: el.id ? `#${el.id}` : "None",
              classes: el.className
                ? `.${el.className.split(" ").join(" .")}`
                : "None",
            };
          })
          .filter((i) => i);

        const allIds = Array.from(doc.querySelectorAll("[id]")).map((el) => ({
          tag: el.tagName.toLowerCase(),
          id: el.id,
        }));
        const redundant = allIds.filter((item) => item.tag === item.id);
        const hasTopId = !!doc.querySelector("body[id], header[id], #top");

        let posCount = 0;
        rules.forEach((r) => {
          if (r.style.position === "absolute" || r.style.position === "fixed")
            posCount++;
        });
        const posRatio = posCount / (rules.length || 1);

        return {
          feature: "Identity & Box Model",
          basic:
            redundant.length === 0 && hasTopId
              ? "Optimal Identity"
              : "Minor: Redundancy/Missing Nav ID",
          advanced: `<strong>Landmark Blocks:</strong><ul class="audit-list">${landmarkDetails.map((i) => `<li>${i.tag}: ID[${i.id}] CLASS[${i.classes}]</li>`).join("")}</ul>Redundant IDs: ${redundant.length}<br>Positioning: ${posCount} abs/fixed (${Math.round(posRatio * 100)}%)`,
          score: posRatio > 0.2 || redundant.length > 0 ? 1 : 0,
          type: "advanced",
        };
      }

      function auditMastery(doc, rawCSS) {
        const checks = [
          { pattern: /@font-face/i, label: "Webfonts (@font-face)" },
          { pattern: /--[a-zA-Z0-9-]+:/i, label: "CSS Variables" },
          { pattern: /:hover/i, label: "Pseudo: :hover" },
          { pattern: /:focus/i, label: "Pseudo: :focus" },
          { pattern: /display:\s*grid/i, label: "CSS Grid" },
          { pattern: /display:\s*flex/i, label: "Flexbox" },
          { pattern: /clamp\(/i, label: "Clamp() Scaling" },
          { tag: "strong", label: "Semantic: strong" },
          { tag: "em", label: "Semantic: em" },
          { tag: "time", label: "Semantic: time" },
          { pattern: /&copy;|&#169;/i, label: "Entity: &copy;" },
        ];
        const found = [];
        const missing = [];
        checks.forEach((c) => {
          let p = c.tag ? !!doc.querySelector(c.tag) : c.pattern.test(rawCSS);
          if (p) found.push(c.label);
          else missing.push(c.label);
        });
        return {
          feature: "Exploration & Mastery",
          basic: `Found: ${found.length} | Missing: ${missing.length}`,
          advanced: `<ul class="audit-list">${found.map((l) => `<li class="status-optimal">${l}</li>`).join("")}${missing.map((l) => `<li class="tag-missing"><del>${l}</del></li>`).join("")}</ul>`,
          score: found.length > 5 ? 0 : 1,
          type: "advanced",
        };
      }

      function auditRWDUnits(rules) {
        const rel = ["rem", "em", "%", "vw", "vh", "dvh", "clamp", "calc"];
        const optSample = [];
        const badSample = [];
        let relCount = 0,
          fixCount = 0;
        rules.forEach((rule) => {
          const isSafeCtx =
            !!rule.media ||
            rule.selector.toLowerCase() === "html" ||
            rule.selector.toLowerCase() === "body";
          Object.entries(rule.style).forEach(([prop, val]) => {
            if (rel.some((u) => val.toLowerCase().includes(u))) {
              relCount++;
              if (optSample.length < 5)
                optSample.push(`${rule.selector} -> ${prop}: ${val}`);
            }
            if (
              val.includes("px") ||
              val.includes("pt") ||
              val.includes("cm")
            ) {
              if (
                !(
                  isSafeCtx ||
                  prop.startsWith("min-") ||
                  prop.startsWith("max-")
                )
              ) {
                fixCount++;
                if (badSample.length < 10)
                  badSample.push(`${rule.selector} -> ${prop}: ${val}`);
              }
            }
          });
        });
        const ratio = fixCount / (relCount + fixCount || 1);
        return {
          feature: "RWD Unit Logic",
          basic: `${ratio > 0.2 ? "Major" : ratio > 0.05 ? "Minor" : "Optimal"}: Bad Fixed: ${fixCount}`,
          advanced: `<strong>Sample Optimal:</strong><ul class="audit-list">${optSample.map((i) => `<li>${i}</li>`).join("")}</ul><strong>Sample Issues:</strong><ul class="audit-list">${badSample.map((i) => `<li class="unit-major">${i}</li>`).join("")}</ul>`,
          score: ratio > 0.2 ? 2 : ratio > 0.05 ? 1 : 0,
          type: "advanced",
        };
      }

      // --- MODULE: Color Contrast (v1.9.6 Shorthand Fix) ---
      function auditContrast(rules) {
        function getComp(path) {
          let c = { color: "#000000", bg: "#FFFFFF" };
          rules.forEach((r) => {
            const sel = r.selector.toLowerCase();
            if (
              path.includes(sel) ||
              sel === "*" ||
              sel === "body" ||
              sel === "html"
            ) {
              if (r.style.color) c.color = r.style.color;
              // Support for shorthand 'background' and specific 'background-color'
              if (r.style["background-color"])
                c.bg = r.style["background-color"];
              else if (r.style.background) {
                const match = r.style.background.match(
                  /#[0-9a-f]{3,6}|rgba?\(.*?\)|[a-z]+/i,
                );
                if (match) c.bg = match[0];
              }
            }
          });
          return c;
        }
        const ctxs = [
          { name: "Body", path: "body" },
          { name: "Nav a", path: "nav a" },
          { name: "Main a", path: "main a" },
          { name: "List a", path: "ul a" },
          { name: "Main P", path: "main p" },
        ];
        const canvas = document.createElement("canvas");
        const ctxCanvas = canvas.getContext("2d");
        const res = ctxs.map((ctx) => {
          const s = getComp(ctx.path);
          ctxCanvas.fillStyle = s.color;
          const fHex = ctxCanvas.fillStyle;
          ctxCanvas.fillStyle = s.bg;
          const bHex = ctxCanvas.fillStyle;
          const parse = (h) => ({
            r: parseInt(h.substring(1, 3), 16),
            g: parseInt(h.substring(3, 5), 16),
            b: parseInt(h.substring(5, 7), 16),
          });
          const f = parse(fHex),
            b = parse(bHex);
          const lum = (c) => {
            const a = [c.r, c.g, c.b].map((v) => {
              v /= 255;
              return v <= 0.03928
                ? v / 12.92
                : Math.pow((v + 0.055) / 1.055, 2.4);
            });
            return a[0] * 0.2126 + a[1] * 0.7152 + a[2] * 0.0722;
          };
          const ratio = (lum(f) + 0.05) / (lum(b) + 0.05);
          const rVal = ratio < 1 ? 1 / ratio : ratio;
          return {
            ...ctx,
            fg: fHex.toUpperCase(),
            bg: bHex.toUpperCase(),
            ratio: rVal,
            sev: rVal >= 7 ? "optimal" : rVal >= 4.5 ? "minor" : "major",
          };
        });
        const palette = [...new Set(res.flatMap((r) => [r.fg, r.bg]))];
        return {
          feature: "Color Contrast (WCAG)",
          basic: res.some((r) => r.ratio < 4.5) ? "Major Failures" : "Optimal",
          advanced:
            res
              .map(
                (r) =>
                  `<div class="contrast-context-box" style="border-left-color:var(--${r.sev === "optimal" ? "terminal-green" : r.sev === "minor" ? "accent-yellow" : "accent-red"})"><strong>${r.name}</strong><div class="demo-pill" style="background-color:${r.bg};color:${r.fg}">Sample text</div><span class="contrast-meta">Ratio: ${r.ratio.toFixed(2)}:1</span></div>`,
              )
              .join("") +
            `<strong>Detected Palette:</strong><div class="swatch-grid">${palette.map((c) => `<div class="swatch-item"><div class="swatch" style="background-color:${c}"></div>${c}</div>`).join("")}</div>`,
          score: res.some((r) => r.ratio < 4.5) ? 2 : 0,
          type: "basic",
        };
      }

      async function startManualAnalysis(html, css) {
        loader.style.display = "block";
        output.innerHTML = `<tr><td colspan="3">BYPASS ACTIVE. Parsing local data...</td></tr>`;
        try {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          const rules = parseCSSRules(css);
          performDiagnosticCore(doc, html, css, rules, [], "Manual Patch");
        } catch (err) {
          output.innerHTML = `<tr><td colspan="3" class="status-major">CRITICAL FAILURE: ${err.message}</td></tr>`;
        } finally {
          loader.style.display = "none";
        }
      }

      async function startAnalysis(url) {
        const adenda =
          SCAN_PHRASES[Math.floor(Math.random() * SCAN_PHRASES.length)];
        loader.style.display = "block";
        output.innerHTML = `<tr><td colspan="3">SCANNING... v1.9.6 Deep Audit. ${adenda}</td></tr>`;
        try {
          const htmlStr = await fetchWithRetry(url);
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlStr, "text/html");
          const links = Array.from(
            doc.querySelectorAll('link[rel="stylesheet"]'),
          ).map((l) => ({
            rel: l.getAttribute("href"),
            abs: new URL(l.getAttribute("href"), url).href,
          }));
          let css = "";
          for (let l of links) {
            try {
              css += await fetchWithRetry(l.abs, 1);
            } catch (e) {}
          }
          const rules = parseCSSRules(css);
          performDiagnosticCore(
            doc,
            htmlStr,
            css,
            rules,
            links,
            url.split("/").pop(),
          );
        } catch (err) {
          output.innerHTML = `<tr><td colspan="3" class="status-major">CRITICAL FAILURE: ${err.message}. Try "Manual Patch" mode if signal is lost.</td></tr>`;
        } finally {
          loader.style.display = "none";
        }
      }

      function performDiagnosticCore(
        doc,
        rawHTML,
        rawCSS,
        rules,
        links,
        filename,
      ) {
        const results = [];
        const hygiene = /^[a-z0-9._-]+$/i.test(filename);
        const pretty = rawHTML.includes("\n  ") || rawHTML.includes("\n\t");
        results.push({
          feature: "File I/O",
          basic: hygiene ? "Optimal Name" : "Major: Filename",
          advanced: `Indentation: ${pretty ? "Optimal" : "Bad"}<br>Target: ${filename}`,
          score: hygiene ? 0 : 2,
          type: "basic",
        });
        const hasStyleTags = doc.querySelectorAll("style").length > 0;
        results.push({
          feature: "CSS Architecture",
          basic: hasStyleTags ? "Major: Internal styles" : "Optimal: External",
          advanced: `Linked: ${links.length} files<br>${links.map((l) => l.rel).join(", ")}`,
          score: hasStyleTags ? 2 : 0,
          type: "basic",
        });
        results.push(auditMetaInfo(doc));
        const std = [
          "header",
          "nav",
          "main",
          "section",
          "article",
          "aside",
          "footer",
        ];
        results.push({
          feature: "HTML5 Landmarks",
          basic:
            std.filter((t) => doc.querySelector(t)).length >= 4
              ? "Optimal"
              : "Minor",
          advanced: std
            .map(
              (t) =>
                `<span class="tag-pill ${doc.querySelector(t) ? "" : "tag-missing"}">${doc.querySelector(t) ? t.toUpperCase() : "<del>" + t.toUpperCase() + "</del>"}</span>`,
            )
            .join(" "),
          score: std.filter((t) => doc.querySelector(t)).length >= 4 ? 0 : 1,
          type: "basic",
        });
        results.push(auditCSSSelectors(doc, rules));
        results.push(auditIdentity(doc, rules));
        const tags = ["body", "h1", "h2", "h3", "p", "a", "ul"];
        const rep = {};
        tags.forEach((t) => {
          let r = "Inherited";
          rules.forEach((ru) => {
            if (ru.selector.toLowerCase() === t && ru.style["font-size"])
              r = ru.style["font-size"];
          });
          rep[t] = r;
        });
        results.push({
          feature: "Typographic Scale",
          basic: rep.p === "Inherited" ? "Minor" : "Optimal",
          advanced: Object.entries(rep)
            .map(([t, d]) => `<li>${t.toUpperCase()}: ${d}</li>`)
            .join(""),
          score: 0,
          type: "basic",
        });
        results.push(auditContrast(rules));
        results.push(auditRWDUnits(rules));
        results.push(auditMastery(doc, rawCSS));
        renderResults(results);
      }

      function renderResults(results) {
        output.innerHTML = "";
        let major = 0,
          minor = 0,
          bFound = 0,
          bTotal = 0,
          aFound = 0,
          aTotal = 0;
        results.forEach((r) => {
          if (r.score === 2) major++;
          else if (r.score === 1) minor++;
          if (r.type === "basic") {
            bTotal++;
            if (r.score === 0) bFound++;
          } else {
            aTotal++;
            if (r.score === 0) aFound++;
          }
          const st =
            r.score === 0
              ? "status-optimal"
              : r.score === 1
                ? "status-minor"
                : "status-major";
          output.innerHTML += `<tr><td>${r.feature}</td><td class="${st}">${r.basic}</td><td>${r.advanced}</td></tr>`;
        });
        document.getElementById("basic-rating").innerText =
          `${Math.round((bFound / bTotal) * 100)}%`;
        document.getElementById("advanced-rating").innerText =
          aTotal > 0 ? `${Math.round((aFound / aTotal) * 100)}%` : "0%";
        document.getElementById("issue-counts").innerText =
          `Major: ${major} | Minor: ${minor}`;
        const grade = document.getElementById("summary-grade");
        grade.innerText =
          major + minor === 0
            ? "OPTIMAL"
            : major === 0
              ? "MINOR ISSUES"
              : "MAJOR ISSUES";
        grade.className =
          major + minor === 0
            ? "status-optimal"
            : major === 0
              ? "status-minor"
              : "status-major";
        summary.style.display = "block";
      }
    </script>
  </body>
</html>
